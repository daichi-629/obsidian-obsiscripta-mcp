# MCP標準方式（Streamable HTTP）への移行計画

## 目的

現在の ObsiScripta Bridge は、以下の二段構成です。

- Obsidian Plugin: 独自 HTTP API（`/bridge/v1/*`）を公開
- stdio Bridge: MCP stdio サーバーとして動作し、Plugin API へフォワード

本計画では、Plugin 側も MCP 標準プロトコル（Streamable HTTP）を直接提供できる構成へ段階移行し、以下を実現します。

- 標準プロトコル準拠による相互運用性の向上
- 独自 API 変換レイヤーの簡素化
- 将来的なステートフル運用（セッション管理）の実装容易化

## スコープ

### 対象

- `packages/obsidian-plugin`: MCP標準HTTPエンドポイント提供
- `packages/stdio-bridge`: 互換層としての段階的縮退
- `packages/shared`: 共通型の整備（必要に応じて）
- `docs/`: 新旧プロトコルの併記と移行ガイド

### 非対象（この計画では実施しない）

- いきなり v1 API を削除する破壊的変更
- 認証機構の導入（将来課題として記録）
- モバイル対応

## マイグレーション方針

- **方針A: 併存期間を設ける（推奨）**
  - 既存 `bridge/v1` を維持しつつ、MCP標準HTTP（v2相当）を追加
  - stdio bridge からは新方式を優先利用、失敗時は v1 フォールバック

## フェーズ計画

## Phase 0: 設計確定（1〜2日）

### タスク

1. MCP標準HTTPの採用仕様を固定（transport, endpoint, error mapping）
2. 既存 `bridge/v1` との差分を整理（機能表・互換方針）
3. セッション方針を決定（クライアント生成ID/サーバー生成ID、TTL、GC）
4. ドキュメント方針を決定（`docs/protocol.md` 更新 + 新規移行ガイド）

### 完了条件

- ADR相当の設計メモがレビュー承認済み
- 実装順とロールバック手順が合意済み

## Phase 1: Plugin 側で MCP標準HTTPを追加（3〜5日）

### タスク

1. Plugin に MCP標準HTTPエンドポイントを追加（既存 v1 は維持）
2. ツール一覧・ツール実行を MCP request/response 形式で処理
3. 既存 ToolExecutor を再利用できるアダプタ層を実装
4. エラーマッピング（バリデーション、ツール実行失敗、内部エラー）を統一

### 完了条件

- 新エンドポイントで `tools/list`, `tools/call` が通る
- v1 (`/bridge/v1/*`) への既存アクセスが壊れていない

## Phase 2: stdio bridge を新方式優先に変更（2〜3日）

### タスク

1. PluginClient に「標準HTTP優先 + v1フォールバック」戦略を実装
2. 起動時ヘルスチェックを新方式に対応
3. フォールバック発生時のログを明確化（理由・回数）
4. Feature flag（環境変数）で強制モード切替を可能にする

### 完了条件

- 新方式が利用可能な環境で stdio bridge が正常起動する
- 新方式が使えない環境で v1 フォールバックが動作する

## Phase 3: ステートフル運用導入（3〜5日）

### タスク

1. `sessionId` を渡せる API 契約を追加
2. Plugin 側に SessionStore（TTL/GC/上限）を導入
3. ツール実行コンテキストへ SessionState を注入
4. セッション管理エンドポイント（必要最小限）を追加

### 完了条件

- 同一 sessionId での連続呼び出しで状態が維持される
- TTL超過時のエラー/再作成挙動が仕様通り

## Phase 4: 安定化・非推奨化アナウンス（2〜4日）

### タスク

1. v1 利用率をログで可視化
2. README / リリースノートで v1 非推奨を告知
3. 非推奨期限（例: 2 minor release 後削除）を明示
4. 主要利用パターンの移行例を公開

### 完了条件

- v1依存の主要クライアントに移行手段が提供済み
- 削除判断に必要なメトリクスが揃っている

## 互換性ポリシー

- セマンティックバージョニングを遵守
- 破壊的変更は major または明確な移行猶予を設定
- 既存の `OBSIDIAN_MCP_HOST` / `OBSIDIAN_MCP_PORT` は維持

## リスクと対策

1. **リスク: 実装が二重化して保守コストが増える**
   - 対策: ToolExecutor を共通コアにし、transportごとの差分を薄くする

2. **リスク: ストリーミング接続周りで不安定化**
   - 対策: タイムアウト・再試行・接続上限を明示設定し、ログ粒度を上げる

3. **リスク: 既存ユーザーの設定が壊れる**
   - 対策: v1 併存とフォールバックを最低1リリース期間維持

4. **リスク: セッションリークでメモリ増加**
   - 対策: TTL + 定期GC + 最大セッション数制限 + サイズ上限

## テスト計画

## 単体

- 型/バリデーション（sessionId, request format）
- エラーマッピング
- SessionStore の TTL/GC

## 結合

- Plugin 単体で標準HTTP経由の `tools/list`, `tools/call`
- stdio bridge 経由で標準HTTP優先・v1フォールバック

## 回帰

- 既存 `bridge/v1` API の互換動作
- 起動/停止/再起動時の接続安定性

## ロールアウト

1. 開発版で標準HTTPをデフォルトOFFで投入
2. CI と手動検証で安定化
3. デフォルトONへ切替（フォールバック維持）
4. 利用率を見ながら v1 非推奨化
5. 期限後に v1 削除

## 成果物チェックリスト

- [ ] Plugin が MCP標準HTTPを公開
- [ ] stdio bridge が新方式優先で接続
- [ ] フォールバックとログ整備
- [ ] セッション管理実装（TTL/GC/制限）
- [ ] docs 更新（プロトコル、移行手順、FAQ）
- [ ] リリースノートに互換ポリシー記載

## 補足

- 今回は「移行計画」を先に固定する段階。
- 実装時は、Phaseごとに小さなPRへ分割し、毎回互換性テストを通す。
